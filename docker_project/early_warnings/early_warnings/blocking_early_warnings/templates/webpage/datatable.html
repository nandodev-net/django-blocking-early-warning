{% extends 'webpage/base.html' %}


{% block title %} Datatable {% endblock title %}

{% block subtitle %}
{% endblock subtitle %}

{% block content %}
    <header>
        <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #222;
                color: #f0f0f0;
            }

            .container {
                width: 80%;
                margin: 0 auto;
            }


            table {
            width: 100%;
            border-collapse: collapse;
            background-color: #222;
            color: #fff;
            }

            th,
            td {
            padding: 15px;
            text-align: left;
            border: 1px solid #555;
            }

            th {
            text-align: center;
            }

            .tdcenter{
            text-align: center;
            }

            thead {
            background-color: #444;
            }

            thead th {
            font-weight: bold;
            color: #fff;
            }

            tbody tr:nth-child(even) {
            background-color: #333;
            }

            tbody tr:hover {
            background-color: #464646;
            }

            .celltooltip {
            position: relative;
            color: #fff;
            }

            .celltooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #000000de;
            color: #fff;
            text-align: left;
            border-radius: 3px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            top: -50px;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            transform: translate3d(90px,-40px,10px);
            
            }

            .celltooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
            }
            .celltooltip .tooltiptext li {
            list-style-type: none;
            }
            .celltooltip .tooltiptext ul {
            display: flex;
            flex-wrap: nowrap;
            }

            .bullet {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
            }

            button {
                margin: 0 10px;
                cursor: pointer;
                background-color: #444;
                border: 1px solid #555;
                color: #f0f0f0;
                padding: 5px 10px;
                font-size: 16px;
                border-radius: 5px;
                outline: none;
                transition: background-color 0.3s;
            }

            button:hover {
                background-color: #555;
            }

            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            a {
                color: #f0f0f0;
                text-decoration: none;
            }

            a:hover {
                text-decoration: underline;
            }

            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                margin: 20px 0;
            }

            .pagination a {
                display: inline-block;
                margin: 0 5px;
                padding: 8px 14px;
                background-color: #444;
                border: none;
                border-radius: 10%;
                color: #f0f0f0;
                text-decoration: none;
                transition: background-color 0.3s, box-shadow 0.3s;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            }

            .pagination a:hover {
                background-color: #555;
                box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
            }

            .pagination a.current {
                font-weight: bold;
                background-color: #555;
                box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
            }

            .pagination a.disabled {
                opacity: 0.5;
                pointer-events: none;
                cursor: not-allowed;
                box-shadow: none;
            }

            .histogram-btn {
                background-color: #4CAF50;
                border: none;
                color: white;
                text-align: center;
                text-decoration: none;
                font-size: 12px;
                padding: 8px 15px;
                border-radius: 50px;
                cursor: pointer;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
                transition: background-color 0.3s, box-shadow 0.3s;
            }

            .histogram-btn:hover {
                background-color: #5CD65C;
                box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
            }

            .charmodal {
                display: none;
                position: fixed;
                z-index: 1;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                max-height: 1000px;
                overflow: auto;
                background-color: rgba(0, 0, 0, 0.5);
            }

            .charmodal-content {
                background-color: #2c2c2c;
                margin: 5% auto; /* Keep 'auto' for left and right margins to center the modal horizontally */
                padding: 20px;
                border: 1px solid #444;
                width: 60%; /* Change the width to 60% */
                color: #fff;
            }

            .close {
                color: #bbb; /* Change the close button color to a lighter gray */
                float: right;
                font-size: 28px;
                font-weight: bold;
            }

            .close:hover,
            .close:focus {
                color: white; /* Change the close button hover color to white */
                text-decoration: none;
                cursor: pointer;
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </header>
    <div class="container">
    <table>
        <thead>
            <tr>
                <th>URL</th>
                <th>ASN</th>
                <th>antier %</th>
                <th>Ayer %</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for dato in datos_paginados %}
                <tr>
                    <td>
                        <span class="celltooltip">{{ dato.url }}
                            <ul class="tooltiptext">
                            <li><span class="bullet" style="background-color: #ff6b6b;"></span> Measurements:125</li>
                            <li><span class="bullet" style="background-color: #6ab04c;"></span> Anomalies: 125</li>
                            <li><span class="bullet" style="background-color: #4aa3df;"></span> ASN: AS8048</li>
                            </ul>
                        </span>
                    </td>
                    <td class="tdcenter">
                        <span class="celltooltip">{{ dato.asn_code }}
                            <ul class="tooltiptext">
                            <li><span class="bullet" style="background-color: #dddf4a;"></span> ASN: {{ dato.asn_name }}</li>
                            </ul>
                        </span>
                    </td>
                    <td class="tdcenter"class="tdcenter">
                        <span class="celltooltip">{{ dato.percentage_2_days_ago }}%
                            <ul class="tooltiptext">
                            <li><span class="bullet" style="background-color: #6ab04c;"></span> Measurements: {{ dato.measurement_count_2_days_ago }}</li>
                            <li><span class="bullet" style="background-color: #ff6b6b;"></span> Anomalies: {{ dato.anomaly_count_2_days_ago }}</li>
                            <li><span class="bullet" style="background-color: #4aa3df;"></span> date: {{ dato.hour_2_days_ago|date:'Y-m-d' }}</li>
                            <li><span class="bullet" style="background-color: #4adadf;"></span> time: {{ dato.hour_2_days_ago|time:"h:i a"  }}</li>
                            </ul>
                        </span>
                    </td>
                    <td class="tdcenter">
                        <span class="celltooltip">{{ dato.percentage_1_days_ago }}%
                            <ul class="tooltiptext">
                                <li><span class="bullet" style="background-color: #6ab04c;"></span> Measurements: {{ dato.measurement_count_1_days_ago }}</li>
                                <li><span class="bullet" style="background-color: #ff6b6b;"></span> Anomalies: {{ dato.anomaly_count_1_days_ago }}</li>
                                <li><span class="bullet" style="background-color: #4aa3df;"></span> date: {{ dato.hour_1_days_ago|date:'Y-m-d' }}</li>
                                <li><span class="bullet" style="background-color: #4adadf;"></span> time: {{ dato.hour_1_days_ago|time:"h:i a"  }}</li>
                            </ul>
                        </span>
                    </td>
                    <td class="tdcenter">
                        <button
                            class="histogram-btn"
                            data-measurement2="{{ dato.measurement_count_2_days_ago }}"
                            data-anomaly2="{{ dato.anomaly_count_2_days_ago }}"
                            data-hour2="{{ dato.hour_2_days_ago|date:'Y-m-d' }}"
                            data-measurement1="{{ dato.measurement_count_1_days_ago }}"
                            data-anomaly1="{{ dato.anomaly_count_1_days_ago }}"
                            data-hour1="{{ dato.hour_1_days_ago|date:'Y-m-d' }}"
                        >
                        Histograma
                        </button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- The modal structure -->
    <div id="myCharModal" class="charmodal">
        <div class="charmodal-content">
          <span class="close">&times;</span>
          <canvas id="myChart"></canvas>
        </div>
      </div>
</div>

    <div class="pagination">
        <span class="step-links">
            {% if datos_paginados.has_previous %}
                <a href="?page=1">&laquo; Primera</a>
                <a href="?page={{ datos_paginados.previous_page_number }}">Anterior</a>
            {% endif %}

            <span class="current">
                Página {{ datos_paginados.number }} de {{ datos_paginados.paginator.num_pages }}.
            </span>

            {% if datos_paginados.has_next %}
                <a href="?page={{ datos_paginados.next_page_number }}">Siguiente</a>
                <a href="?page={{ datos_paginados.paginator.num_pages }}">Última &raquo;</a>
            {% endif %}
        </span>
    </div>

    <script>

        document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById("myCharModal");
        const btn = document.getElementById("myBtn");
        const span = document.getElementsByClassName("close")[0];
        const ctx = document.getElementById("myChart").getContext("2d");
        let myChart;

        // Create a function to generate the histogram with the provided values
        function createHistogram(data) {
            if (myChart){
                myChart.destroy()
            }
            // Clear the canvas to remove any previous charts
            //ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            const ctx = document.getElementById("myChart").getContext("2d");

            myChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: [data.hour2, data.hour1],
                datasets: [
                {
                    label: "Anomalies",
                    data: [data.anomaly2, data.anomaly1],
                    backgroundColor: "rgba(237, 15, 198, 0.6)",
                    borderColor: "rgba(237, 15, 198, 1)",
                    borderWidth: 1,
                },
                {
                    label: "Measurements",
                    data: [data.measurement2, data.measurement1],
                    backgroundColor: "rgba(92, 214, 92, 0.6)",
                    borderColor: "rgba(92, 214, 92, 1)",
                    borderWidth: 1,
                },
                ],
            },
            options: {
                scales: {
                y: {
                    beginAtZero: true,
                    stacked: false,
                    ticks: {
                    color: 'white',
                    },
                    grid: {
                    color: 'rgba(255, 255, 255, 0.1)',
                    },
                },
                x: {
                    stacked: true,
                    ticks: {
                    color: 'white',
                    },
                    grid: {
                    color: 'rgba(255, 255, 255, 0.1)',
                    },
                },
                },
                plugins: {
                legend: {
                    labels: {
                    color: 'white',
                    },
                },
                },
            },
            });
        }

        // Function to close the modal
        function closeModal() {
            modal.style.display = "none";
            document.body.style.overflow = "auto";
        }

        // Assign an event handler to each button to show the modal with the corresponding histogram
        document.querySelectorAll(".histogram-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
            
            const data = {
                measurement2: btn.dataset.measurement2,
                anomaly2: btn.dataset.anomaly2,
                hour2: btn.dataset.hour2,
                measurement1: btn.dataset.measurement1,
                anomaly1: btn.dataset.anomaly1,
                hour1: btn.dataset.hour1,
            };
            console.table({
                measurement2: data.measurement2,
                anomaly2: data.anomaly2,
                hour2: data.hour2,
                measurement1: data.measurement1,
                anomaly1: data.anomaly1,
                hour1: data.hour1,
            
            });
            
            createHistogram(data);
            modal.style.display = "block";
            document.body.style.overflow = "hidden";
            });
        });

        // Close the modal when the 'X' is clicked
        span.onclick = closeModal;

        // Close the modal when clicking outside the modal content
        window.onclick = function (event) {
            if (event.target == modal) {
            closeModal();
            }
        };
        });


    </script>
{% endblock %}